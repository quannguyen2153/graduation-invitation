<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>T·∫°o link t·ªët nghi·ªáp b√≠ m·∫≠t</title>
    <style>
        body {
            font-family: "Arial", sans-serif;
            background: linear-gradient(135deg, #d4fc79, #96e6a1);
            padding: 40px 16px;
            color: #333;
            display: flex;
            justify-content: center;
        }

        #wrapper {
            max-width: 640px;
            width: 100%;
            background: #fff;
            border-radius: 18px;
            padding: 24px 28px 28px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.12);
        }

        h1 {
            margin-top: 0;
            margin-bottom: 4px;
            font-size: 24px;
            color: #27ae60;
        }

        p.subtitle {
            margin-top: 0;
            margin-bottom: 18px;
            color: #777;
            font-size: 14px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-top: 14px;
            margin-bottom: 6px;
        }

        textarea {
            width: 100%;
            min-height: 70px;
            resize: vertical;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 14px;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: 14px;
            box-sizing: border-box;
        }

        button {
            margin-top: 18px;
            padding: 10px 20px;
            border-radius: 999px;
            border: none;
            cursor: pointer;
            background: #27ae60;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
        }

        button:disabled {
            opacity: 0.6;
            cursor: default;
        }

        .output-block {
            margin-top: 22px;
            padding-top: 14px;
            border-top: 1px solid #eee;
            font-size: 13px;
        }

        .output-block code {
            display: block;
            margin-top: 4px;
            padding: 6px 8px;
            border-radius: 6px;
            background: #f5f5f5;
            word-break: break-all;
        }

        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 6px;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <h1>T·∫°o link l·ªùi m·ªùi b√≠ m·∫≠t üéì</h1>
    <p class="subtitle">Nh·∫≠p c√¢u <strong>title</strong>, <strong>thankyou</strong> v√† text c·ªßa n√∫t <strong>Yes/No</strong>, r·ªìi nh·∫≠n link ƒë√£ m√£ h√≥a (param duy nh·∫•t <code>for</code>) ƒë·ªÉ g·ª≠i cho b·∫°n.</p>

    <label for="titleInput">Title (c√¢u m·ªü ƒë·∫ßu)</label>
    <textarea id="titleInput" placeholder="C·∫≠u ƒë·∫øn d·ª± l·ªÖ t·ªët nghi·ªáp c·ªßa Qu√¢n nh√©! üéì"></textarea>

    <label for="thankyouInput">Thankyou (c√¢u c·∫£m ∆°n)</label>
    <textarea id="thankyouInput" placeholder="C·∫£m ∆°n c·∫≠u nhi·ªÅu l·∫Øm! ‚ù§Ô∏è H·∫πn g·∫∑p c·∫≠u ·ªü l·ªÖ t·ªët nghi·ªáp!"></textarea>

    <label for="nameInputField">T√™n ng∆∞·ªùi nh·∫≠n (t√πy ch·ªçn)</label>
    <input id="nameInputField" type="text" placeholder="T√™n c·∫≠u..." />

    <label for="yesInput">Text n√∫t Yes</label>
    <textarea id="yesInput" placeholder="Oke lun"></textarea>

    <label for="noInput">Text n√∫t No</label>
    <textarea id="noInput" placeholder="Hong ƒë∆∞·ª£c r√πi"></textarea>

    <button id="encryptBtn">T·∫°o link m√£ h√≥a</button>

    <div class="output-block" id="output" style="display:none;">
        <div>
            <strong>Encrypted title</strong>
            <code id="encTitle"></code>
        </div>
        <div style="margin-top: 8px;">
            <strong>Encrypted thankyou</strong>
            <code id="encThankyou"></code>
        </div>
        <div style="margin-top: 10px;">
            <strong>URL ƒë·ªÉ g·ª≠i cho b·∫°n</strong>
            <code id="finalUrl"></code>
        </div>
        <div class="hint">
            G·ª£i √Ω: copy nguy√™n ƒë∆∞·ªùng link tr√™n v√† g·ª≠i cho b·∫°n. Khi m·ªü, trang <code>index.html</code>
            s·∫Ω t·ª± gi·∫£i m√£ v√† hi·ªÉn th·ªã l·ªùi m·ªùi.
        </div>
    </div>
</div>

<script>
    const encryptBtn = document.getElementById("encryptBtn");
    const titleInput = document.getElementById("titleInput");
    const thankyouInput = document.getElementById("thankyouInput");
    const nameInputField = document.getElementById("nameInputField");
    const yesInput = document.getElementById("yesInput");
    const noInput = document.getElementById("noInput");
    const output = document.getElementById("output");
    const encTitleEl = document.getElementById("encTitle");
    const encThankyouEl = document.getElementById("encThankyou");
    const finalUrlEl = document.getElementById("finalUrl");

    function toBase64(bytes) {
        let binary = "";
        for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    }

    async function encryptAes256CbcToBase64(plaintext, passphrase) {
        const enc = new TextEncoder();
        const data = enc.encode(plaintext);

        const passphraseKey = await crypto.subtle.importKey(
            "raw",
            enc.encode(passphrase),
            { name: "PBKDF2" },
            false,
            ["deriveKey"]
        );

        const salt = enc.encode("graduation-salt");
        const key = await crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt,
                iterations: 100000,
                hash: "SHA-256"
            },
            passphraseKey,
            { name: "AES-CBC", length: 256 },
            false,
            ["encrypt"]
        );

        const iv = crypto.getRandomValues(new Uint8Array(16));

        const encryptedBuffer = await crypto.subtle.encrypt(
            { name: "AES-CBC", iv },
            key,
            data
        );

        const encryptedBytes = new Uint8Array(encryptedBuffer);
        const combined = new Uint8Array(iv.length + encryptedBytes.length);
        combined.set(iv, 0);
        combined.set(encryptedBytes, iv.length);

        return toBase64(combined);
    }

    encryptBtn.addEventListener("click", async () => {
        const titleText = titleInput.value.trim();
        const thankyouText = thankyouInput.value.trim();
        const nameText = nameInputField.value.trim();
        const yesText = yesInput.value.trim();
        const noText = noInput.value.trim();

        encryptBtn.disabled = true;
        encryptBtn.textContent = "ƒêang m√£ h√≥a...";

        try {
            const passphrase = "graduation";

            const payload = {
                title: titleText || "",
                thankyou: thankyouText || "",
                name: nameText || "",
                yes: yesText || "",
                no: noText || "",
            };

            const jsonString = JSON.stringify(payload);
            const encFor = await encryptAes256CbcToBase64(jsonString, passphrase);

            encTitleEl.textContent = encFor;
            encThankyouEl.textContent = "(g√≥i chung trong param 'for')";

            const baseUrl = window.location.origin +
                window.location.pathname.replace(/[^/]*$/, "") +
                "index.html";

            const params = new URLSearchParams();
            params.set("for", encFor);

            const finalUrl = baseUrl + "?" + params.toString();
            finalUrlEl.textContent = finalUrl;

            output.style.display = "block";
        } catch (e) {
            console.error(e);
            alert("C√≥ l·ªói khi m√£ h√≥a. Th·ª≠ l·∫°i sau nh√©.");
        } finally {
            encryptBtn.disabled = false;
            encryptBtn.textContent = "T·∫°o link m√£ h√≥a";
        }
    });
</script>

</body>
</html>


